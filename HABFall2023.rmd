---
title: "HAB Fall 2023 Draft"
output: html_document
date: "2023-12-14"
---

## Library + Vignette

```{r}
library(rEDM)
library(tidyverse)
library(googlesheets4)
library(padr)
library(oce)
library(tseries)
library(forecast)
library(spatstat)
library(tseries)
library(corrplot)
library(lubridate)
library(psych)
library(Hmisc)




```

library(zoo) library(dataRetrieval) library(Hmisc) library(reshape2) library(plyr) \## Data Wrangling

```{r}
#Charles River
#Reads data into R
CR2023 <- read_sheet('https://docs.google.com/spreadsheets/d/1R_HdqGuVMlfRyVPCzOw3CvbOjXDQfzFtDCMvKdj5vXU/edit?usp=sharing')

CR2022 <- read_sheet('https://docs.google.com/spreadsheets/d/1equdXHt4d-2s3r8YSsuHfpLufeRmGqno-SJqhcEwuNY/edit?usp=sharing')

CR2021 <- read_sheet('https://docs.google.com/spreadsheets/d/1CBzAD9uot_SPkY-JV-lJB6FSxSjlgXIS8A4jSY9SJjE/edit?usp=sharing')

CR2020 <- read_sheet('https://docs.google.com/spreadsheets/d/1fOV7JfJwLxddCaTsR0vkUodOZup4Y6HwVthMLzexe-I/edit?usp=sharing')

CR2019 <- read_sheet('https://docs.google.com/spreadsheets/d/1WGTUQ7F8wadO4RJ6PsfRsEnvwqNMdnAsdX71xqI9L-4/edit?usp=sharing')

CR2018 <- read_sheet('https://docs.google.com/spreadsheets/d/17AX8HNLXUCYz6YJIHRnb_rrKuzDudyAEq5WEhbSxOFQ/edit?usp=sharing')

CR2017 <- read_sheet('https://docs.google.com/spreadsheets/d/18xDJ9cLaZuj3JqhFsf847nSLMGKjfvWZmHWifsrPBq8/edit?usp=sharing')

CR2016 <- read_sheet('https://docs.google.com/spreadsheets/d/1rEOGM2H9cgVbFgVkIQZjIyzzl03fIywtkxBNg7GmXrY/edit?usp=sharing')

CR2015 <- read_sheet('https://docs.google.com/spreadsheets/d/11I8RQnOgZ9xmVEpaTVM_ELQZdTTp6T_305nwxkNI92I/edit?usp=sharing')

#Prints the data
```

```{r}
#bind rows
df_CR <- bind_rows(
  CR2015,
  CR2016,
  CR2017, 
  CR2018,
  CR2019,
  CR2020,
  CR2021,
  CR2022,
  CR2023
)
#combine data
df_CR <- df_CR %>%
  mutate(hour = pmin(hour(`time est`),hour(`time edt`),na.rm=T),
         minute = pmin(minute(`time est`),minute(`time edt`),na.rm=T)) %>%
  select(date,hour,minute,chl=`chlorophyll (rfu)`,phy=`phycocyanin (rfu)`, ph=`ph`, Celsius =`temp c`,  spcond = `spcond (ms/cm)`, do = `do (mg/l)`,turb = `turbidity (fnu)` )
  
#%>% rename(`time est`=time)

```

### Convert to Salinity

```{r}

df_CR$Salinity <- 

  swSCTp(
  df_CR$spcond,
df_CR$Celsius,
  pressure = rep(10.1325,NROW(df_CR)),
  # "mS/cm",
"",
  eos = getOption("oceEOS", default = "gsw")
)

```

# Non-Aggregated Values

## Visualize 2021 Salinity + Chl

```{r}
#Visualize Salinity 2021 

df_CR %>%
  mutate(date = as.Date(date)) %>%
  group_by(date) %>%
  filter(date >= as.Date("2021-05-01") & date <= as.Date("2021-11-01"))  %>%
  ggplot(aes(x = date)) + 
  geom_path(aes(y = Salinity, color = "Salinity")) +
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  ggtitle("Salinity 2021") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Month", y = "Salinity (ppm)")

#Visualize Chl 2021 

df_CR %>%
  mutate(date = as.Date(date)) %>%
  group_by(date) %>%
  filter(date >= as.Date("2021-05-01") & date <= as.Date("2021-11-01"))  %>%
  ggplot(aes(x = date)) + 
  geom_path(aes(y = chl, color = "chl")) +
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  ggtitle("Chlorophyll 2021") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Month", y = "Chlorophyll (RFU)")
  
```

#add rows w/ missing NA values

```{r}

df_CR <- df_CR %>% pad()

```

### Plot Chl + Phy

```{r}

df_CR %>% group_by(date,hour) %>%
    filter(year(date) >= 2021) %>%
  summarise(across(c("chl","phy"),mean),.groups="keep") %>%
  mutate(date= date+hours(hour)) %>%
  ggplot(aes(x=date)) + 
  geom_path(aes(y=chl,color="chl")) + 
  geom_path(aes(y=phy,color="phy")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(" < 2021 Chlorophyll V. Phycocanin ") + 
    labs(x = "Dates", y = "RFU")


```

### Plot \> 2021 EPA Buoy Vars

```{r}


df_CR %>%
  group_by(date, hour) %>%
  filter(year(date) >= 2021) %>%
  summarise(across(c("chl", "phy", "ph", "Celsius", "spcond", "do", "turb", "Salinity"), mean), .groups = "keep") %>%
  mutate(date = date + hours(hour)) %>%
  ggplot(aes(x = date)) +
  geom_path(aes(y = chl, color = "Chlorophyll (RFU)")) +
  geom_path(aes(y = phy, color = "Phycocanin (RFU)")) +
  geom_path(aes(y = ph, color = "pH")) +
  geom_path(aes(y = Celsius, color = "Temperature (Celsius)")) +
  geom_path(aes(y = spcond, color = "Specific Conductance Ratio (mS/cm)")) +
  geom_path(aes(y = do, color = "Dissolved Oxygen (mg/L)")) +
  geom_path(aes(y = turb, color = "Turbidity (FNU)")) +
  geom_path(aes(y = Salinity, color = "Salinity (ppm)")) +
  scale_color_manual(
    values = c("Chlorophyll (RFU)" = "green",
               "Phycocanin (RFU)" = "orange",
               "pH" = "brown",
               "Temperature (Celsius)" = "red",
               "Specific Conductance Ratio (mS/cm)" = "pink",
               "Dissolved Oxygen (mg/L)" = "yellow",
               "Turbidity (FNU)" = "purple",  # Removed the extra space here
               "Salinity (ppm)" = "blue"),
    name = "Color"
  ) + 
  labs(x = "Dates", y = "Units") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(" < 2021 All EPA Buoy Variables")

```

### Plot All EPA Buoy Vars All Time

```{r}
df_CR %>%
  group_by(date, hour) %>%
  summarise(across(c("chl", "phy", "ph", "Celsius", "spcond", "do", "turb", "Salinity"), mean), .groups = "keep") %>%
  mutate(date = date + hours(hour)) %>%
  ggplot(aes(x = date)) +
  geom_path(aes(y = chl, color = "Chlorophyll (RFU)")) +
  geom_path(aes(y = phy, color = "Phycocanin (RFU)")) +
  geom_path(aes(y = ph, color = "pH")) +
  geom_path(aes(y = Celsius, color = "Temperature (Celsius)")) +
  geom_path(aes(y = spcond, color = "Specific Conductance Ratio (mS/cm)")) +
  geom_path(aes(y = do, color = "Dissolved Oxygen (mg/L)")) +
  geom_path(aes(y = turb, color = "Turbidity (FNU)")) +
  geom_path(aes(y = Salinity, color = "Salinity (ppm)")) +
  scale_color_manual(
    values = c("Chlorophyll (RFU)" = "green",
               "Phycocanin (RFU)" = "orange",
               "pH" = "brown",
               "Temperature (Celsius)" = "red",
               "Specific Conductance Ratio (mS/cm)" = "pink",
               "Dissolved Oxygen (mg/L)" = "yellow",
               "Turbidity (FNU)" = "purple",
               "Salinity (ppm)" = "blue"),
    name = "Color"
  ) + 
      labs(x = "Dates", y = "Units") +
theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("All EPA Buoy Vars")
```

###PCF

```{r}
df_CR <- na.omit(df_CR)

#Run ACF CHL, PHY 2021
ts_chl_2021 <- df_CR %>% 
  filter(year(date) == 2021) %>%
  group_by(date,hour) %>%
  summarise(across(c("chl","phy"),mean),.groups = "keep") %>%
  pull(chl)

ts_phy_2021 <- df_CR %>% 
  filter(year(date) == 2021) %>%
  group_by(date,hour) %>%
  summarise(across(c("chl","phy"),mean),.groups = "keep") %>%
  pull(phy)


length(ts_chl_2021)
acf(ts_chl_2021,lag.max = 24*30)
abline(h = c(0.3,0.6) , col = c("red","red")) #change to lagmax = 30 if want days 
#determine lag -talk to deyle?
acf(ts_phy_2021,lag.max = 24*30)
abline(h = c(0.3,0.6) , col = c("red","red"))



## you can check an individual value as follows
cor(ts_phy_2021,lag(ts_phy_2021,6),use="pairwise")

```

#Aggreggated Values

```{r}

#Aggregate Values Daily

ag_df_CR <-df_CR %>%
   group_by(date) %>%
  summarise(chl=mean(chl), phy=mean(phy), ph=mean(ph), Celsius=mean(Celsius), spcond=mean(spcond), do=mean(do), turb=mean(turb), Salinity = mean(Salinity))


```

## ARIMA Aggreggated Daily

```{r}
ag_df_CR <- na.omit(ag_df_CR)


class(ag_df_CR)
ag_df_CR$chl <- as.numeric(ag_df_CR$chl)


#Fit Dataset
rate <- ts(ag_df_CR[,'chl'],start = c(2015,5), frequency = 365 )

#Grab Data
autoplot(rate) + ggtitle ("Autoplot - Daily Aggregate ") + ylab("Chlorophyll (RFU)") + theme(plot.title = element_text(hjust = 0.5))



#Build ARIMA Model - include seasonal autoregressive and seasonal autoregressive moving averages.
fit_ARIMA <-auto.arima(rate, seasonal = TRUE)
print(summary(fit_ARIMA))
checkresiduals(fit_ARIMA)


#Forecast
fcast <- forecast(fit_ARIMA, h =200) #h = amount of periods ahead
autoplot
plot(fcast)
print(summary(fcast))

#Fitting an auto.arima model in R using the Forecast package
#fit_basic1<- auto.arima(df_CR,xreg=trainREG_TS)
#forecast_1<-forecast(fit_basic1,xreg = testREG_TS)
```

### PCF

```{r}

df_CR <- na.omit(df_CR)
df_CR <- char2numeric(ag_df_CR)  #this makes all numeric
p <- pcf(Kest(df_CR$chl))
plot(p)

# fv object
  K <- Kest(df_CR$chl)
  p2 <- pcf(K, spar=0.8, method="b")
  plot(p2)

  my_array <-simplify2array(df_CR$chl)


```

###ACF

###PCF

```{r}
pcf(s_chl_2021,lag.max = 24*30)
```

### PACF

```{r}
#Take away NA values 
ag_df_CR <- na.omit(ag_df_CR) 
pacf(df_CR$chl, lag.max = 7)

```

```{r}
#**CHL**

#45 days 

pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(chl) %>%
  pacf(lag.max=45) 
plot(pacf2021, main = "Chlorophyll PACF - 45 days")


#30 days
pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(chl) %>%
  pacf(lag.max=30)
plot(pacf2021, main = "Chlorphyll PACF - 30 days")


#7 days
pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(chl) %>%
  pacf(lag.max=7)
plot(pacf2021, main = "Chlorphyll PACF - 7 days")

#1 day
pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(chl) %>%
  pacf(lag.max=7)
plot(pacf2021, main = "Chlorphyll PACF - 1 day")



```

```{r}
#**PHY**

#45 days 

pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(phy) %>%
  pacf(lag.max=45) 
plot(pacf2021, main = "Phycocanin - 45 days")


#30 days
pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(phy) %>%
  pacf(lag.max=30)
plot(pacf2021, main = "Phycocanin PACF - 30 days")


#7 days
pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(phy) %>%
  pacf(lag.max=7)
plot(pacf2021, main = "Phycocanin PACF - 7 days")

#1 day
pacf2021 <- ag_df_CR %>% 
  filter(year(date)==2021) %>%
  pull(phy) %>%
  pacf(lag.max=7)
plot(pacf2021, main = "Phycocanin PACF - 1 day")
```

### Coefficients of Correlation

```{r}

describe(ag_df_CR)  #this will flag those variables that are categorical with an asterix
numericag <- char2numeric(ag_df_CR)  #this makes all numeric
cor_data = cor(numericag)
cor_data <- cor_data[-c(1),-c(1) ] #remove 1st row + column
print("Correlation matrix")
print(cor_data)
corrplot(cor_data, method="number")
corrplot(cor_data, method="circle")



rcorr(as.matrix(numericag[-1,-1]), type = c("pearson"))



```

# 9-12 Values

```{r}

morndf_CR <- df_CR %>%
  filter(hour %in% c(9, 10, 11))

morndf_CR <-morndf_CR %>%
   group_by(date) %>%
  summarise(chl=mean(chl), phy=mean(phy), ph=mean(ph), Celsius=mean(Celsius), spcond=mean(spcond), do=mean(do), turb=mean(turb), Salinity = mean(Salinity))
```

### Coefficients of Correlation

```{r}
morndf_CR <- na.omit(morndf_CR)
describe(morndf_CR)  #this will flag those variables that are categorical with an asterix
numericag <- char2numeric(morndf_CR)  #this makes all numeric
cor_data = cor(numericag)
cor_data <- cor_data[-c(1),-c(1) ] #remove 1st row + column
print("Correlation matrix")
print(cor_data)
corrplot(cor_data, method="number")
corrplot(cor_data, method="circle")

rcorr(as.matrix(numericag[-1,-1]), type = c("pearson"))

```

### First Diff Phy

```{r}
ag_df_CR <- ag_df_CR %>% pad %>%
+  mutate(del_phy = phy - lag(phy,1))
 ag_df_CR %>% ggplot(aes(x=date,y=del_phy)) + geom_line()

ag_df_CR %>% filter(year(date) >= 2021) %>% ggplot(aes(x=date,y=del_phy)) + geom_line()

ag_df_CR %>% filter(year(date) >= 2021) %>% ggplot(aes(x=date,y=del_phy)) + geom_line() + geom_line(aes(y=phy,color="phy"))
```

# EDM

## EDM Uni-variate Analysis

## EDM 9-12

## EDM Daily 

Read Data + Find Parameters

```{r}
#READ DATA
#ag_df_CR <- read.csv("C:/Users/mfman/OneDrive/Desktop/HAB-Thesis/ag_df_CR.csv")

#ag_df_CR$date <- as.Date(ag_df_CR$date)
```

```{r}

#Without NA Values
#morn_dfCR <- na.omit(morn_dfCR) 

ag_df_CR <- na.omit(ag_df_CR) 

# Find the first row number for the first date in 2023
first_row_2023 <- which(format(ag_df_CR$date, "%Y") == "2023")[1]

print(first_row_2023)

# Find the last value 
last_value <- nrow(ag_df_CR)

print(last_value)

```

```{r}
rm(last_value)
rm(first_row_2023)
```

### Optimal Embedding Dimension

-   rho_E

    -   E

    -   Rho

**Replace Rho_AR with preds_AR?**

```{r}
lib_ins <- c(1,1075) # data up through end of 2022; this is the training set
lib_oos <- c(1076,1223) # leave this alone until we're nearly done with the project

rho_E <- EmbedDimension(dataFrame = ag_df_CR, columns = "chl", target = "chl",
lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 

# we can use S-map with E=1 and theta=0 to get the AR(1) forecast skill
preds_AR <- SMap(dataFrame = ag_df_CR, columns = "chl", target = "chl",
lib = lib_ins, pred = lib_ins, E=1,theta=0) #lib train, #pred is pred 

stats_AR <- ComputeError(preds_AR$predictions$Observations,
                         preds_AR$predictions$Predictions)


rho_E %>%
  ggplot(aes(x=E,y=rho)) + 
  geom_line(color="blue") +
  geom_hline(aes(yintercept = stats_AR$rho),lty=2,color="black") +
  ylim(0,1)
  

#rho_E <- EmbedDimension(dataFrame = ag_df_CR, columns = "chl", target = "chl",
#lib = "1 1075", pred = "1076 1223", showPlot = TRUE) #lib train, #pred is pred 

#lib = "1 100 101 200 301 400", - leaving one out

```

"At a daily time-scale, EDM predictions do not beat the strong day-to-day autocorrelation in the signal." This is no surprise. Let's look again with a larger tau, informed by the previous ACF analysis; we saw a signal somewhere in the window of 4 days - 1 week.

4-days:

```{r}
tau_i <- 4

# Same as before but using a larger tau and setting Tp = tau

rho_E_tau_i_0 <- EmbedDimension(dataFrame = ag_df_CR, columns = "chl", target = "chl",
                        tau=-tau_i,Tp=tau_i,
lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 


rho_E_tau_i <- EmbedDimension(dataFrame = ag_df_CR, columns = "chl", target = "chl",
                        tau=-tau_i,Tp=tau_i,
                        exclusionRadius = tau_i, # exclude 2*tau additional points in cross-val
lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 


# we can use S-map with E=1 and theta=0 to get the AR(1) forecast skill
preds_AR <- SMap(dataFrame = ag_df_CR, columns = "chl", target = "chl",
lib = lib_ins, pred = lib_ins, E=1,theta=0,tau=-tau_i,Tp=tau_i,exclusionRadius=tau_i) #lib train, #pred is pred 

stats_AR <- ComputeError(preds_AR$predictions$Observations,
                         preds_AR$predictions$Predictions)


rho_E_tau_i %>%
  ggplot(aes(x=E,y=rho)) + 
  geom_line(aes(color="correct")) +
  geom_line(data=rho_E_tau_i_0,aes(color="wrong")) +
  geom_hline(aes(yintercept = stats_AR$rho),lty=2,color="black") +
  ylim(0,1) +
  labs(title=paste0("Simplex with tau = ",tau_i))
  
```

**E = 6 here?**

```{r}
rho_theta_tau_i <- PredictNonlinear(dataFrame = ag_df_CR, columns = "chl", target = "chl",
                                    E=9,
                                    tau=-tau_i,Tp=tau_i,exclusionRadius = tau_i,
                                    lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 

preds_AR1 <- SMap(dataFrame = ag_df_CR, columns = "chl", target = "chl",
lib = lib_ins, pred = lib_ins, E=1,theta=0,tau=-tau_i,Tp=tau_i,exclusionRadius=tau_i) #lib train, #pred is pred 

stats_AR1 <- ComputeError(preds_AR1$predictions$Observations,
                         preds_AR1$predictions$Predictions)


rho_theta_tau_i %>%
  ggplot(aes(x=Theta,y=rho)) + 
  geom_line() +
  # geom_line(data=rho_E_tau_i_0,aes(color="wrong")) +
  geom_hline(aes(yintercept = stats_AR$rho),lty=2,color="black") +
  # ylim(0,0.5) +
  labs(title=paste0("Simplex with tau = ",tau_i))

```

1 week:

```{r}
tau_i <- 7

# Same as before but using a larger tau and setting Tp = tau

rho_E_tau_i_0 <- EmbedDimension(dataFrame = ag_df_CR, columns = "chl", target = "chl",
                        tau=-tau_i,Tp=tau_i,
lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 


rho_E_tau_i <- EmbedDimension(dataFrame = ag_df_CR, columns = "chl", target = "chl",
                        tau=-tau_i,Tp=tau_i,exclusionRadius = tau_i,
lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 


# we can use S-map with E=1 and theta=0 to get the AR(1) forecast skill
preds_AR <- SMap(dataFrame = ag_df_CR, columns = "chl", target = "chl",
lib = lib_ins, pred = lib_ins, E=1,theta=0,tau=-tau_i,Tp=tau_i,exclusionRadius=tau_i) #lib train, #pred is pred 

stats_AR <- ComputeError(preds_AR$predictions$Observations,
                         preds_AR$predictions$Predictions)


rho_E_tau_i %>%
  ggplot(aes(x=E,y=rho)) + 
  geom_line(aes(color="correct")) +
  geom_line(data=rho_E_tau_i_0,aes(color="wrong")) +
  geom_hline(aes(yintercept = stats_AR$rho),lty=2,color="black") +
  ylim(0,1) +
  labs(title=paste0("Simplex with tau = ",tau_i))
  
```

```{r}

rho_theta_tau_i <- PredictNonlinear(dataFrame = ag_df_CR, columns = "chl", target = "chl",
                                    E=5,
                                    tau=-tau_i,Tp=tau_i,exclusionRadius = tau_i,
                                    lib = lib_ins, pred = lib_ins, showPlot = TRUE) #lib train, #pred is pred 

preds_AR1 <- SMap(dataFrame = ag_df_CR, columns = "chl", target = "chl",
lib = lib_ins, pred = lib_ins, E=1,theta=0,tau=-tau_i,Tp=tau_i,exclusionRadius=tau_i) #lib train, #pred is pred 

stats_AR1 <- ComputeError(preds_AR1$predictions$Observations,
                         preds_AR1$predictions$Predictions)


rho_theta_tau_i %>%
  ggplot(aes(x=Theta,y=rho)) + 
  geom_line() +
  # geom_line(data=rho_E_tau_i_0,aes(color="wrong")) +
  geom_hline(aes(yintercept = stats_AR$rho),lty=2,color="black") +
  ylim(0,0.5) +
  labs(title=paste0("Simplex with tau = ",tau_i))

```

### Prediction Decay

-   rho_Tp

    -   Tp

    -   Rho

```{r}

rho_Tp <- PredictInterval(dataFrame = ag_df_CR, lib = lib_ins, pred = lib_ins, target = "chl",
columns = "chl", E = 6)
#long-term memory in system (ACF), long term -persistent auto-correlation 


```

### S-Map

-   rho_theta_e3

    -   Theta

    -   Rho

```{r}

rho_theta_e3 = PredictNonlinear(dataFrame = ag_df_CR, columns = "chl",
target = "chl", lib = lib_ins, pred = lib_ins, E = 4)

```

### **Evaluate Simplex Prediction**

-   ag_df_CRPredict

    -   Observations

    -   Predictions

    -   Pred_Variance

```{r}

ag_df_CRPredict <- Simplex(dataFrame = ag_df_CR,lib = lib_ins, pred = lib_ins, pred = "1076 1223", target = "chl",
columns = "chl", E = 4)

#S-Map = Theta



```

```{r}

 ComputeError(ag_df_CRPredict$Observations, ag_df_CRPredict$Predictions)
 
```

### Evaluate S-Map

It can be advantageous to combine different time series to create the phase-space embedding, providing they are observed from the same system.

-   Smap

    -   predictions

    -   coefficents

    -   singularvalues

    -   ∂chl/∂chl(t-1,2,3,4)

**#Where does TentMapNoise come from? SMapPredict?**

**Tentmap Noise = Theta?**

**What is columns?**

```{r}

 #If θ= 0, all library points have the same weight regardless of the local state of the predictee; 

smap = SMap(dataFrame = ag_df_CR, lib = lib_ins, pred = lib_ins, target = "chl",
columns = "chl", E = 4, theta = 5)

#if h > θ, the forecast given by the S-map depends on the local state of the predictee, and thus produces locally different fittings.
#smap = SMap(dataFrame = ag_df_CR, lib = "1 1075", pred = "1076 1223", target = "chl",
#columns = "chl", E = 2, theta = 0)

```

```{r}
head(cbind(smap$predictions, smap$coefficients), 2)

tail(cbind(smap$predictions, smap$coefficients))


```

### Convergent Cross Mapping (CCM)

find out multivariate

```{r}
#**Deyle** 

cmap <- CCM(dataFrame = ag_df_CR, E = 4, Tp = 2, columns = "chl", target = "turb", libSizes = "10 70 5", sample = 100, showPlot = TRUE)

#tp - 2012 paper 
```

# EDM Mulit-variate Analysis

### Generalized Takens Theorem

smplx_3CR

### Save as New

```{r}
block_4CR <- smap$coefficients  

_new_names <- c(   "date",   "C0",   "t-0",   "t-1",   "t-2",   "t-3" )  

block_4CR <- block_4CR %>%   set_names(v_new_names)  

head(block_4CR)
```

**What is target? t-0?**

smplx_3species

-   observations

-   predicitons

-   pred variance

```{r}


smplx_3CR = Simplex(dataFrame = block_4CR, lib = "1 74", pred = "75 149", E = 4, columns = "t-0 t-1 t-2 t-3", target = "t-0", embedded = TRUE)

err = ComputeError(smplx_3CR$Observations, smplx_3CR$Predictions)
plot(smplx_3CR$Observations, smplx_3CR$Predictions, pch = 19, cex = 0.5,
xlab = "Observations", ylab = "Predictions", main = "3 CR x_t")
abline(a = 0, b = 1, lty = 2, col = "blue")
text(-1, 1, paste(capture.output(cbind(err)), collapse = "\n"))
```

```{r}
#**is this for one variable?**

#head(ag_df_CR,3)

#simplexforecasting

#smplx_3CR = Simplex(dataFrame = ag_df_CR, lib = "1 100", pred = "101 190",
#E = 2, columns = "ph Celsius chl", target = "chl", embedded = TRUE)
#are we using all the columns?
```

Plot

```{r}
#err = ComputeError(smplx_3CR$Observations, smplx_3CR$Predictions)
#plot(smplx_3CR$Observations, smplx_3CR$Predictions, pch = 19, cex = 0.5,
#xlab = "Observations", ylab = "Predictions", main = "3 CR x_t")
#abline(a = 0, b = 1, lty = 2, col = "blue")
#text(-1, 1, paste(capture.output(cbind(err)), collapse = "\n"))

```

### S-Map Coefficents

The Lorenz5D data.frame contains a N=5 dimensional system with F=8 from (Lorenz 1996). Here, we use SMap() to compute a 4-dimensional forecast at Tp=1:

```{r}
colnames(ag_df_CR) #pull col names
head(ag_df_CR)
smap_CR <- SMap(dataFrame = ag_df_CR, lib = "1 500", pred = "601 900", E = 4,
theta = 5, columns = "chl phy ph Celsius spcond do turb", target = "chl", embedded = TRUE)
```

```{r}
head(cbind(smap_CR$predictions, smap_CR$coefficients[, 2:6]), 3)

```

```{r}
#**review w/ Deyle**
#View(predictions)
predictions = smap_CR$predictions
coefficients = smap_CR$coefficients
Time = predictions$Time
plot(Time, predictions$Observations, type = "l", col = "blue", ylab = "chl", xlab = "",
lwd = 2, cex.lab = 1.3, cex.axis = 1.3)
lines(Time, predictions$Predictions, lwd = 2, col = "red")
legend("topright", legend = c("observed", "predicted"), fill = c("blue", "red"),
bty = "n", cex = 1.3)

plot(Time, coefficients[, 6], type = "l", col = "brown", ylab = paste("", "V4/",
"", "chl", sep = ""), xlab = "", lwd = 2, cex.lab = 1.3, cex.axis = 1.3)

plot(Time, coefficients[, 5], type = "l", col = "darkgreen", ylab = paste("",
"V3/", "", "chl", sep = ""), xlab = "", lwd = 2, cex.lab = 1.3, cex.axis = 1.3)

plot(Time, coefficients[, 4], type = "l", col = "blue", ylab = paste("", "V2/",
"", "chl", sep = ""), xlab = "", lwd = 2, cex.lab = 1.3, cex.axis = 1.3)

```

```{r}
Mview = Multiview(dataFrame = df_CR, lib = "1 100", pred = "101 190", E = 3,
columns = "chl phy ph Celsius spcond do turb", target = "chl")
```

```{r}

Mview$View[which(Mview$View$rho > 0.91), ]

```

### 
